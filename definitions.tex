\section{Definitions}
\label{sec:definitions}


\begin{definition}
	A ""population protocol with unordered data"" ("PPUD") is a tuple $(Q, \Delta, I, O)$ with $Q$ a finite set of states,
	$\Delta \subseteq Q^2 \times \set{=, \neq} \times Q^2$ a set of transitions,
	$I \subseteq Q$ a set of initial states, and
	$O : Q \to \set{\top, \bot}$ an output function.
	
	In this work we are interested in ""immediate observation PPUD"" ("IOPPUD"), which is the subclass of protocols in which every transition is of the form $(q_1, q_2, \sim, q_1, q_3)$, with $q_1, q_2, q_3 \in Q$ and $\sim \in \set{=, \neq}$.
	We will denote such transitions by $q_2 \trans{q_1}{\sim} q_3$.
\end{definition}

We fix an infinite data domain $\Dataset$, an infinite set of agents $\Agentset$ and a function $\intro*\dataof : \Agentset \to \Dataset$ such that $\dataof^{-1}(d)$ is infinite for all $d \in \Dataset$. 



A ""configuration"" is a function $\config : \Agentset \to Q \cup \set{\bot}$. We write $\intro*\configset$ for the set of all "configurations". Given a configuration $\config$, we define $\counting{\config} : \Dataset \to \nats^Q$ such that for all $d \in \Dataset, q \in Q$, $\counting{\config}(d)(q) = \size{\set{a \in \Agentset \mid \dataof(a) = d \land \config(a) =q}}$.


A ""step"" $\config_1 \step{\sim}{a}{a_o} \config_2$ with $\config_1, \config_2 \in \configset$, $\sim~ \in \set{=, \neq}$ and $a, a_o \in \Agentset$ is defined when there exists  $\delta = q_1 \trans{q}{\sim} q_2 \in \Delta$ and $d, d_o \in \Dataset$ such that $\config_1(a) = (q_1, d)$, $\config_2(a) = (q_2, d)$ and $\config_1(a_o) = \config_2(a_o) = (q, d_o)$ and $\config_1(a') = \config_2(a')$ for all $a' \neq a$, and $d \sim d_o$.
We say that agent $a$ ""observes"" agent $a_o$. 
We will write $\config_1 \to \config_2$ to say that there exist $a, a_0$ and $\sim$ such that $\config_1 \step{\sim}{a}{a_o} \config_2$.

A ""run"" $\run$ is a sequence of consecutive "steps" $\run: \config_0 \to \config_1 \to \cdots \to  \config_m$.
Further, for all $i \in \nset{1}{m}$, we define the prefix run $\prefixrun{\run}{i} = \config_0 \to \config_1 \to \cdots \to  \config_i$ and suffix run $\suffixrun{\run}{i} = \config_i \to \config_{i+1} \to \cdots \to  \config_m$. We write $\run : \config \xrightarrow{*} \config'$ to say that $\run$ goes from $\config$ to $\config'$. 

We also define for all "configurations" $\config$ the set $\Reach(\config) = \set{\config' \in \configset \mid \exists \run : \config \xrightarrow{*} \config'}$.


\begin{definition}
	Let $\run : \config_1 \xrightarrow{*} \config_2$ be a "run", $d\in \Dataset$, $\Agentset_o$ the agents with datum $d$ that are "observed" in $\run$. For all $q_1, q_2 \in Q$ let $\Agentset_{q_1, q_2}$ be the set of agents with datum $d$ that start in $q_1$ and end in $q_2$.
	
	We define the ""trace"" of $d$ in $\run$ as the function $\trace{d}{\run} : Q^2 \to \nats$ such that for all $q_1, q_2 \in Q$,	$\trace{d}{\run}(q_1, q_2) = \size{\Agentset_{q_1, q_2}}$
		
	
	We define the ""shadow"" of $d$ in $\run$ as the function $\shadow{d}{\run} : Q^2 \to \nats \cup \set{\bot}$ such that for all $q_1, q_2 \in Q$, 
	\begin{equation}
		\shadow{d}{\run}(q_1, q_2) = 
		\left\{
		\begin{aligned}
			&\bot &\text{ if } \Agentset_{q_1,q_2} =\emptyset\\
			&\size{\Agentset_o \cap \Agentset_{q_1, q_2}} &\text{ otherwise.}
		\end{aligned}
		\right.
	\end{equation}
\end{definition}
%	
The "trace" and "shadow" of $d$ describe the flow of its agents between states in the "run". For each pair of states $q_1, q_2$, the "trace" counts the number of agents going from $q_1$ to $q_2$ while
the "shadow" simply indicates if some agents went from $q_1$ to $q_2$ and counts the "observed" ones among them. The idea behind the "shadow" is that if two data $d, d'$ have the same "shadow" in $\run$ and no agent of $d'$ is "externally observed", then we can make each agent of $d'$ copycat an agent of $d$ so that in the end they all reach the same end configuration.


\begin{definition}
	A ""predicate"" is a boolean combination of formulas of the form $\exists d_1, \ldots, d_k, \psi$ with $\psi$ a boolean combination of inequalities of the form $\#(q,d_i) \leq B$ with $q\in Q$, $i \in \nset{1}{k}$ and $B \in \nats$.
	
	A ""specification"" is a formula of the form $Q_1 \config_1, Q_2 \config_2  \in \Reach(\config_1), \ldots, Q_p \config_p \in \Reach(\config_{p-1}), \phi$, where for each $i \in \nset{1}{p}$, $Q_i$ is a quantifier and $\phi$ is a boolean combination of pairs $(\config_i, \psi)$ with $i \in \nset{1}{p}$ and $\psi$ a "predicate".
\end{definition}
